<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ether Nexus | Nexus Meet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://meet.jit.si/external_api.js'></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #050505; color: #ffffff; }
        .glass-panel { background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); }
        .form-input { background: #0a0a0a; border: 1px solid rgba(255,255,255,0.1); padding: 0.75rem; width: 100%; color: white; font-size: 11px; outline: none; }
        .btn-action { transition: 0.3s; text-transform: uppercase; letter-spacing: 0.2em; font-size: 10px; font-weight: 900; }
        .room-card:hover { border-color: #6366f1; background: rgba(99, 102, 241, 0.05); }
    </style>
</head>
<body class="p-4 md:p-8">

    <nav class="max-w-7xl mx-auto flex items-center justify-between mb-8 border-b border-white/5 pb-4">
        <a href="dashboard.html" class="text-gray-500 hover:text-white transition-colors uppercase text-[10px] font-black tracking-widest">
            <i class="fas fa-arrow-left mr-2"></i> Workspace
        </a>
        <span class="text-[10px] font-black uppercase tracking-widest text-indigo-500">Nexus Meet Terminal</span>
    </nav>

    <main class="max-w-7xl mx-auto">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            
            <div class="lg:col-span-1 space-y-6">
                <div class="glass-panel p-6">
                    <h3 class="text-[11px] font-black uppercase mb-4 tracking-widest text-indigo-400">Crear Nueva Terminal</h3>
                    <input type="text" id="newRoomName" placeholder="NOMBRE DE LA SALA..." class="form-input mb-4">
                    <button onclick="crearSalaFirebase()" class="btn-action w-full bg-indigo-600 py-3 hover:bg-white hover:text-black">
                        Abrir Canal
                    </button>
                </div>

                <div class="glass-panel p-6">
                    <h3 class="text-[11px] font-black uppercase mb-4 tracking-widest">Salas Activas</h3>
                    <div id="listaSalas" class="space-y-3 max-h-[400px] overflow-y-auto">
                        <p class="text-[9px] text-gray-600 uppercase italic">Buscando se√±ales...</p>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-3">
                <div id="meet-container" class="w-full h-[650px] glass-panel flex items-center justify-center border-dashed border-2 border-white/5">
                    <div class="text-center" id="meet-placeholder">
                        <i class="fas fa-satellite text-5xl text-white/5 mb-4"></i>
                        <p class="text-gray-600 text-[10px] uppercase font-black tracking-widest">Selecciona o crea una sala para conectar</p>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDX7CbuvxbiNBhJS1mM9xmFiO5tCiFMUCI",
            authDomain: "ether-nexus-intranet.firebaseapp.com",
            projectId: "ether-nexus-intranet",
            storageBucket: "ether-nexus-intranet.firebasestorage.app",
            messagingSenderId: "380189316193",
            appId: "1:380189316193:web:a3f0f430c2e26f5e9e4620"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let jitsiApi = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                escucharSalas();
            } else {
                window.location.href = "index.html";
            }
        });

        // 1. GUARDAR SALA EN FIREBASE
        window.crearSalaFirebase = async () => {
            const nombre = document.getElementById('newRoomName').value.trim();
            if (!nombre) return alert("Ingresa un nombre para la sala");

            const roomID = "EtherNexus_" + nombre.replace(/\s+/g, '_') + "_" + Math.floor(Math.random() * 1000);

            try {
                await addDoc(collection(db, "salas_activas"), {
                    nombre: nombre,
                    roomID: roomID,
                    creador: currentUser.email,
                    creadoEn: serverTimestamp()
                });
                document.getElementById('newRoomName').value = "";
                conectarJitsi(roomID);
            } catch (e) {
                console.error("Error al crear sala:", e);
            }
        };

        // 2. ESCUCHAR SALAS EN TIEMPO REAL
        function escucharSalas() {
            const q = query(collection(db, "salas_activas"), orderBy("creadoEn", "desc"));
            
            onSnapshot(q, (snapshot) => {
                const lista = document.getElementById('listaSalas');
                lista.innerHTML = "";
                
                snapshot.forEach((doc) => {
                    const sala = doc.data();
                    lista.innerHTML += `
                        <div onclick="conectarJitsi('${sala.roomID}')" 
                             class="room-card glass-panel p-3 cursor-pointer border-l-2 border-transparent transition-all">
                            <p class="text-[10px] font-black uppercase text-white">${sala.nombre}</p>
                            <p class="text-[8px] text-gray-600 uppercase font-bold mt-1">Por: ${sala.creador.split('@')[0]}</p>
                        </div>
                    `;
                });
            });
        }

        // 3. CONECTAR A JITSI
        window.conectarJitsi = (roomID) => {
            if (jitsiApi) jitsiApi.dispose(); // Cerrar sala anterior si existe

            const options = {
                roomName: roomID,
                width: '100%',
                height: '100%',
                parentNode: document.querySelector('#meet-container'),
                userInfo: {
                    email: currentUser.email,
                    displayName: currentUser.email.split('@')[0].toUpperCase()
                },
                interfaceConfigOverwrite: {
                    TOOLBAR_BUTTONS: ['microphone', 'camera', 'desktop', 'chat', 'raisehand', 'hangup', 'tileview']
                }
            };

            document.getElementById('meet-container').innerHTML = "";
            jitsiApi = new JitsiMeetExternalAPI("meet.jit.si", options);
        };

    </script>
</body>
</html>